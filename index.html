<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
  />
  <title>Y2K | ROAST RECORDS</title>
  <meta
    name="description"
    content="The CROFAM music + Bet-Fi hub. Submit a request, fund the ecosystem, track bets, and fuel Y2K buybacks."
  />
  <meta name="theme-color" content="#0a0a0a" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; --accent:#ff00ff; }
    html{ background:#0a0a0a; }
    body{ color:#e2e8f0; font-family:'Rubik',sans-serif; overflow-x:hidden; }
    html,body{ overflow-x:hidden; width:100%; }
    #particleCanvas{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:0; }
    .neon-text{ font-family:'Orbitron',sans-serif; text-shadow:0 0 5px var(--accent),0 0 10px var(--accent); }
    .neon-border{ border:2px solid var(--accent); box-shadow:0 0 10px var(--accent); border-radius:10px; }
    .glass-card{ background:rgba(255,255,255,.04); backdrop-filter: blur(12px); border-radius:14px; padding:1.25rem; }
    .glow-button{ padding:.75rem 1.5rem; border:1px solid var(--accent); background:rgba(255,0,255,.1); color:#fff; border-radius:8px; font-weight:700; transition:.3s; cursor:pointer; display:inline-block; min-width:200px; text-align:center;}
    .glow-button:hover{ background:rgba(255,0,255,.2); box-shadow:0 0 20px var(--accent); transform:translateY(-2px);}
    .portal-ring{ position:absolute; border:2px solid var(--accent); border-radius:50%; left:50%; top:50%; transform:translate(-50%,-50%); animation:portalPulse 2s infinite;}
    .portal-ring:nth-child(1){ width:200px; height:200px; animation-delay:0s;}
    .portal-ring:nth-child(2){ width:160px; height:160px; animation-delay:-.5s;}
    .portal-ring:nth-child(3){ width:120px; height:120px; animation-delay:-1s;}
    @keyframes portalPulse{0%{transform:translate(-50%,-50%) scale(.95); opacity:.5}50%{transform:translate(-50%,-50%) scale(1.05); opacity:1}100%{transform:translate(-50%,-50%) scale(.95); opacity:.5}}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  </style>
</head>

<body class="bg-black text-white overflow-x-hidden relative">
  <canvas id="particleCanvas"></canvas>

  <!-- Portal Entry -->
  <div id="portalEntry" class="fixed inset-0 bg-black/90 flex flex-col justify-center items-center z-50 px-4">
    <div class="relative mb-8 flex justify-center items-center">
      <div class="portal-ring absolute"></div>
      <div class="portal-ring absolute"></div>
      <div class="portal-ring absolute"></div>
      <div class="w-32 h-32 rounded-full neon-border"
        style="background:url('https://raw.githubusercontent.com/LandoCrissian/Y2kCoin-Website/main/IMG_5445.jpeg') center/cover; animation:spin 14s linear infinite;">
      </div>
    </div>
    <h1 class="text-4xl neon-text font-bold mb-6 text-center">Welcome to Y2K</h1>
    <button onclick="enterPortal()" class="glow-button text-xl w-full max-w-xs">Initialize Connection</button>
  </div>

  <!-- Trust strip -->
  <div class="fixed top-0 left-0 w-full z-40 text-center text-xs sm:text-sm py-2 bg-gradient-to-r from-pink-500 via-fuchsia-600 to-purple-700 text-white font-semibold tracking-wide shadow-md">
    CROFAM Verified ‚Ä¢ Fueled by $Y2K and $ROAST
  </div>

  <!-- MAIN -->
  <div id="mainContent" class="hidden pt-24 relative z-10">

    <!-- Emblem -->
    <section class="flex flex-col items-center justify-center px-4 pt-6 pb-10">
      <div class="w-32 h-32 rounded-full neon-border mb-6"
           style="background:url('https://raw.githubusercontent.com/LandoCrissian/Y2kCoin-Website/main/IMG_5445.jpeg') center/cover; animation:spin 14s linear infinite;">
      </div>
    </section>

    <!-- Quick actions -->
    <section class="px-4 pb-12 max-w-md mx-auto grid grid-cols-2 gap-4">
      <a href="#studio" class="glow-button text-sm flex items-center justify-center gap-2">üéôÔ∏è Studio</a>
      <a href="/airdrops.html" class="glow-button text-sm flex items-center justify-center gap-2">üéÅ Airdrops</a>
      <a href="https://y2k-powerball.netlify.app/" target="_blank" class="glow-button text-sm flex items-center justify-center gap-2">üéØ Y2K Powerball</a>
      <a href="https://obsidian.finance/?outputCurrency=0xB4Df7d2A736Cc391146bB0dF4277E8F68247Ac6d" target="_blank" class="glow-button text-sm flex items-center justify-center gap-2">üü£ Buy $Y2K</a>
      <a href="https://raydium.io/launchpad/token/?mint=A6db9o4y5phC5ncSdM8pQKmWanodxLyXgwxuVCuA4ray" target="_blank" class="glow-button text-sm flex items-center justify-center gap-2">üî• Trade $ROAST</a>
      <!-- NEW: Bet-Fi jump -->
      <a href="#betfi" class="glow-button text-sm flex items-center justify-center gap-2">üí∏ Y2K Bet-Fi</a>
    </section>

    <!-- =========================
         Y2K Bet-Fi Dashboard
         ========================= -->
    <section id="betfi" class="px-4 pt-2 pb-12 max-w-screen-lg mx-auto">
      <h2 class="text-3xl neon-text font-bold mb-3 text-center">Y2K Bet-Fi</h2>
      <p class="text-sm text-gray-400 text-center mb-6">
        Public betting ladder ‚Üí profits fuel <span class="text-pink-400">$Y2K</span> buybacks on Cronos.
      </p>

      <!-- KPIs -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="glass-card neon-border p-3"><div class="text-xs text-gray-400">Live Bankroll</div><div id="kpi-bankroll" class="text-2xl font-bold mono">$‚Äî</div></div>
        <div class="glass-card neon-border p-3"><div class="text-xs text-gray-400">Total Buybacks</div><div id="kpi-buybacks" class="text-2xl font-bold mono">$‚Äî</div></div>
        <div class="glass-card neon-border p-3"><div class="text-xs text-gray-400">Hit Rate</div><div id="kpi-hitrate" class="text-2xl font-bold mono">‚Äî%</div></div>
        <div class="glass-card neon-border p-3"><div class="text-xs text-gray-400">Best Payout</div><div id="kpi-best" class="text-2xl font-bold mono">$‚Äî</div></div>
      </div>

      <!-- Lists -->
      <div class="grid md:grid-cols-2 gap-4">
        <div class="glass-card neon-border">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-bold">Live Bets & Results</h3>
            <button id="btn-add-bet" class="glow-button text-xs px-3 py-1">+ Add Bet</button>
          </div>
          <div id="betsList" class="space-y-2"></div>
        </div>

        <div class="glass-card neon-border">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-bold">Buyback Ledger (Cronos)</h3>
            <button id="btn-add-buyback" class="glow-button text-xs px-3 py-1">+ Add Buyback</button>
          </div>
          <div id="buybacksList" class="space-y-2"></div>
        </div>
      </div>

      <!-- Coming soon -->
      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="glass-card neon-border border-dashed">
          <div class="flex items-center justify-between">
            <h3 class="font-bold">Coming Soon ‚Äî Live Sweat</h3>
            <span class="text-xs px-2 py-1 rounded-full bg-yellow-600/30 border border-yellow-500/50">Building</span>
          </div>
          <p class="text-sm text-gray-400 mt-2">Realtime game feed, HR alerts, auto parlay tracking.</p>
        </div>
        <div class="glass-card neon-border border-dashed">
          <div class="flex items-center justify-between">
            <h3 class="font-bold">Coming Soon ‚Äî Community Picks</h3>
            <span class="text-xs px-2 py-1 rounded-full bg-yellow-600/30 border border-yellow-500/50">Building</span>
          </div>
          <p class="text-sm text-gray-400 mt-2">Vote on parlays, weekly ladders, leaderboards.</p>
        </div>
      </div>
    </section>

    <!-- ROAST RECORDS Form -->
    <section id="studio" class="px-4 pb-20 max-w-screen-md mx-auto">
      <h2 class="text-3xl neon-text font-bold text-center mb-6">ROAST RECORDS</h2>
      <div class="flex justify-center mb-2">
        <button onclick="connectWallet()" class="glow-button text-sm w-full max-w-xs">Connect Wallet</button>
      </div>
      <div id="walletStatus" class="text-center text-sm text-green-400 mt-2"></div>

      <form id="submissionForm" class="space-y-4">
        <select id="requestType" required class="w-full p-3 neon-border bg-black text-white text-sm text-center rounded">
          <option value="">Select Type</option>
          <option value="Anthem">Anthem / Theme</option>
          <option value="Custom">Custom Song</option>
          <option value="Roast">Roast</option>
          <option value="Other">Intro / Skit</option>
        </select>

        <input id="handle" placeholder="@YourHandle" required class="w-full p-3 neon-border bg-black text-white text-center rounded text-sm"/>

        <textarea id="notes" placeholder="Describe your request..."
          class="w-full p-3 neon-border bg-black text-white rounded text-sm h-28 resize-none"></textarea>

        <label class="flex items-center gap-3 text-white text-sm">
          <input type="checkbox" id="limitedMint" class="accent-pink-500 w-5 h-5"/>
          <span>Request Limited Mint (10 editions at 50 CRO each)</span>
        </label>

        <button type="button" onclick="submitStudioRequest()" class="w-full glow-button text-sm">
          Submit Request (20 CRO)
        </button>
      </form>

      <div id="studioStatus" class="text-center text-sm pt-2"></div>
    </section>

    <!-- Confirmation -->
    <div id="confirmationOverlay" class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col justify-center items-center px-4 text-center">
      <div class="glass-card neon-border w-full max-w-md p-6 space-y-4">
        <h3 class="text-xl font-bold neon-text">Submission Confirmed</h3>
        <p class="text-sm text-gray-300">Let the world know what you submitted.</p>
        <div class="text-sm bg-black text-white p-3 rounded neon-border" id="sharePreview"></div>
        <button id="shareOnX" class="glow-button text-sm w-full">Share on ùïè</button>
        <button id="copyBtn" class="glow-button text-sm w-full">Copy Text</button>
        <button id="closeBtn" class="glow-button text-sm w-full">Close</button>
      </div>
    </div>

    <!-- Live Submissions -->
    <section id="live" class="px-4 pt-12 pb-20 bg-[#0b0b0b] text-center">
      <h2 class="text-3xl md:text-4xl neon-text font-bold mb-2">Live Submissions</h2>
      <p class="text-sm text-gray-400 italic mb-6">Updated in real time. All requests are verified and chain-linked.</p>
      <div id="liveRequests" class="flex overflow-x-auto snap-x snap-mandatory gap-4 px-1 pb-2 scroll-smooth max-w-full max-w-screen-xl mx-auto"></div>
    </section>

    <!-- Certified Showcase -->
    <section id="certified" class="px-4 pb-20 bg-black text-center">
      <h2 class="text-3xl neon-text font-bold mb-2">ROAST CERTIFIED</h2>
      <p class="text-sm text-gray-400 italic mb-6">Official stamped requests from the vault.</p>
      <div id="adminAddCertified" class="mt-4 flex justify-center hidden">
        <button onclick="openAddCertifiedModal()" class="px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white text-sm rounded shadow">
          + Manually Add Certified
        </button>
      </div>
      <div id="certifiedSwipeContainer" class="flex overflow-x-auto snap-x snap-mandatory gap-4 pb-2 scroll-smooth"></div>
    </section>

    <!-- Live Mints -->
    <section id="mints" class="px-4 py-6">
      <h2 class="text-2xl neon-text font-bold mb-4 text-center">Live Mints</h2>
      <div class="overflow-x-auto">
        <div class="flex gap-3 pb-4" style="width:max-content;">
          <a href="https://eric-mode-business-boomin.nfts2.me/" target="_blank" class="glass-card w-64">
            <img src="https://raw.githubusercontent.com/LandoCrissian/Y2kCoin-Website/refs/heads/main/IMG_5510.jpeg" class="w-full rounded mb-2" alt="ERIC"/>
            <h3 class="font-bold">ERIC</h3><p class="text-xs text-gray-400">The original anthem</p>
          </a>
          <a href="https://cronoshadow.nfts2.me/" target="_blank" class="glass-card w-64">
            <img src="https://raw.githubusercontent.com/LandoCrissian/Y2kCoin-Website/refs/heads/main/IMG_5403.jpeg" class="w-full rounded mb-2" alt="Cards"/>
            <h3 class="font-bold">Cards of Cronos</h3><p class="text-xs text-gray-400">Your on-chain fate</p>
          </a>
          <a href="https://dojo-warriors-anthem.nfts2.me/" target="_blank" class="glass-card w-64">
            <img src="https://raw.githubusercontent.com/LandoCrissian/Y2kCoin-Website/refs/heads/main/IMG_5285.jpeg" class="w-full rounded mb-2" alt="DOJO"/>
            <h3 class="font-bold">DOJO</h3><p class="text-xs text-gray-400">Discipline & chaos</p>
          </a>
          <a href="https://creative-diamondhands-final-strike-mode.nfts2.me/" target="_blank" class="glass-card w-64">
            <img src="https://raw.githubusercontent.com/LandoCrissian/Y2kCoin-Website/refs/heads/main/IMG_5299.jpeg" class="w-full rounded mb-2" alt="DiamondHands"/>
            <h3 class="font-bold">DiamondHands</h3><p class="text-xs text-gray-400">Final Strike Mode</p>
          </a>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="py-6 text-center text-xs text-gray-500 max-w-screen-md mx-auto">
      <div class="mb-3">Built for CROFAM ‚Ä¢ Fueled by Y2K energy</div>
      <div class="flex justify-center gap-4 text-white">
        <a href="https://discord.gg/XxtpYNXX4a" target="_blank" class="hover:text-pink-400">Discord</a>
        <a href="https://x.com/y2kc0in?s=21" target="_blank" class="hover:text-pink-400">ùïè</a>
        <a href="https://y2k-the-vault.netlify.app/" target="_blank" class="hover:text-pink-400">Vault</a>
      </div>
    </footer>
  </div>

  <!-- Toasts -->
  <div id="toastContainer" class="fixed bottom-6 right-6 space-y-2 z-50"></div>

  <!-- Modals: Bet-Fi admin -->
  <div id="betModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center px-4">
    <div class="bg-gray-900 border border-pink-600 rounded-lg w-full max-w-md p-5 space-y-3">
      <h3 class="text-lg font-bold text-pink-400">Add Bet</h3>
      <input id="betTitle" class="w-full p-2 neon-border bg-black text-white text-sm rounded" placeholder="Title (e.g., 3-Leg HR Parlay)" />
      <input id="betMarket" class="w-full p-2 neon-border bg-black text-white text-sm rounded" placeholder="Market / Odds (e.g., HR Parlay ‚Ä¢ +6600)" />
      <input id="betPayout" class="w-full p-2 neon-border bg-black text-white text-sm rounded" placeholder="Potential payout in USD (e.g., 666)" />
      <div class="flex gap-2 pt-2">
        <button id="saveBetBtn" class="glow-button w-full text-sm">Save</button>
        <button id="closeBetBtn" class="glow-button w-full text-sm bg-red-600">Cancel</button>
      </div>
    </div>
  </div>

  <div id="buybackModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center px-4">
    <div class="bg-gray-900 border border-pink-600 rounded-lg w-full max-w-md p-5 space-y-3">
      <h3 class="text-lg font-bold text-pink-400">Add Buyback</h3>
      <input id="bbUSD" class="w-full p-2 neon-border bg-black text-white text-sm rounded" placeholder="USD amount (e.g., 250)" />
      <input id="bbAmount" class="w-full p-2 neon-border bg-black text-white text-sm rounded" placeholder="Y2K amount (e.g., 120000)" />
      <input id="bbTx" class="w-full p-2 neon-border bg-black text-white text-sm rounded" placeholder="Cronoscan tx URL" />
      <input id="bbNote" class="w-full p-2 neon-border bg-black text-white text-sm rounded" placeholder="Note (optional)" />
      <div class="flex gap-2 pt-2">
        <button id="saveBuybackBtn" class="glow-button w-full text-sm">Save</button>
        <button id="closeBuybackBtn" class="glow-button w-full text-sm bg-red-600">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App Scripts -->
  <script type="module">
    /* ---------- Firebase Init (11.6.1) ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, getDoc, updateDoc,
      query, orderBy, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLGt0gVlI8BKdrpME4IefwVjF_ehJJmug",
      authDomain: "y2kroast-512ee.firebaseapp.com",
      projectId: "y2kroast-512ee",
      storageBucket: "y2kroast-512ee.appspot.com",
      messagingSenderId: "602588659855",
      appId: "1:602588659855:web:f01efa4b81e737d26270fa"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // expose for other inline scripts (if any)
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.doc = doc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.onSnapshot = onSnapshot;
    window.query = query;
    window.orderBy = orderBy;
    window.setDoc = setDoc;
    window.serverTimestamp = serverTimestamp;

    /* ---------- Admin wallet (single source) ---------- */
    window.ADMIN_WALLET = "0x99FD6Daaa57ebE7f10Ee94E6c1b7522Fa2b0d100".toLowerCase();

    /* ---------- Bet-Fi live streams ---------- */
    const kpiBankroll = document.getElementById('kpi-bankroll');
    const kpiBuybacks= document.getElementById('kpi-buybacks');
    const kpiHitRate = document.getElementById('kpi-hitrate');
    const kpiBest    = document.getElementById('kpi-best');
    const betsList   = document.getElementById('betsList');
    const buybacksList = document.getElementById('buybacksList');

    const fmtUSD = n => (n==null||isNaN(n))?"$‚Äî":Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
    const fmtPct = n => (n==null||isNaN(n))?"‚Äî%":`${(Number(n)*100).toFixed(1)}%`;
    const tsText = t => { if(!t)return ""; const d=t.toDate?t.toDate():new Date(); return d.toLocaleString(); };
    const isAdmin = () => (window.connectedWallet||"").toLowerCase() === window.ADMIN_WALLET;

    const statsRef = doc(db,"stats","bankroll");
    onSnapshot(statsRef,(snap)=>{
      const s = snap.exists()? snap.data() : {bankroll:0,buybacksUSD:0,hitRate:0,bestPayout:0};
      kpiBankroll.textContent = fmtUSD(s.bankroll||0);
      kpiBuybacks.textContent = fmtUSD(s.buybacksUSD||0);
      kpiHitRate.textContent  = fmtPct(s.hitRate||0);
      kpiBest.textContent     = fmtUSD(s.bestPayout||0);
    });

    const betsQ = query(collection(db,"bets"), orderBy("ts","desc"));
    onSnapshot(betsQ,(snap)=>{
      betsList.innerHTML = snap.empty ? `<div class="text-sm text-gray-400">No bets yet.</div>` : "";
      snap.docs.forEach(d=>{
        const b = { id:d.id, ...d.data() };
        const chip = b.status==="win"?"bg-green-600/30 border border-green-500/40"
          : b.status==="loss"?"bg-red-600/30 border border-red-500/40"
          : b.status==="live"?"bg-emerald-600/30 border border-emerald-500/40"
          : "bg-yellow-600/30 border border-yellow-500/40";
        const row = document.createElement('div');
        row.className = "flex items-center justify-between gap-3 p-3 rounded-lg bg-black/40 border border-white/10";
        row.innerHTML = `
          <div>
            <div class="font-bold">${b.title||"‚Äî"}</div>
            <div class="text-xs text-gray-400">${b.market||""} ‚Ä¢ ${tsText(b.ts)}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs px-2 py-1 rounded-full ${chip}">${(b.status||"pending").toUpperCase()}</span>
            <div class="mono">${b.payout? fmtUSD(b.payout):""}</div>
            ${isAdmin()?`
              <button data-win class="text-xs px-2 py-1 bg-green-700 rounded">Win</button>
              <button data-loss class="text-xs px-2 py-1 bg-red-700 rounded">Loss</button>
            `:""}
          </div>
        `;
        if(isAdmin()){
          row.querySelector('[data-win]')?.addEventListener('click',()=>resolveBet(b.id,"win"));
          row.querySelector('[data-loss]')?.addEventListener('click',()=>resolveBet(b.id,"loss"));
        }
        betsList.appendChild(row);
      });
    });

    const buyQ = query(collection(db,"buybacks"), orderBy("ts","desc"));
    onSnapshot(buyQ,(snap)=>{
      buybacksList.innerHTML = snap.empty ? `<div class="text-sm text-gray-400">No buybacks yet.</div>` : "";
      snap.docs.forEach(d=>{
        const x = { id:d.id, ...d.data() };
        const row = document.createElement('div');
        row.className = "flex items-center justify-between gap-3 p-3 rounded-lg bg-black/40 border border-white/10";
        row.innerHTML = `
          <div>
            <div class="font-bold">Buyback ${fmtUSD(x.usd||0)}</div>
            <div class="text-xs text-gray-400">${x.note||"Automated"} ‚Ä¢ ${tsText(x.ts)}</div>
          </div>
          <div class="flex items-center gap-2">
            <div class="mono text-sm">${x.amount? `${x.amount} Y2K`:""}</div>
            ${x.tx? `<a href="${x.tx}" target="_blank" rel="noopener" class="text-xs px-2 py-1 bg-purple-700 rounded">Tx</a>`:""}
          </div>
        `;
        buybacksList.appendChild(row);
      });
    });

    function toggleAdminButtons(){
      const show = isAdmin();
      const ab = document.getElementById('btn-add-bet');
      const bb = document.getElementById('btn-add-buyback');
      if(ab) ab.style.display = show? "inline-flex":"none";
      if(bb) bb.style.display = show? "inline-flex":"none";
    }
    window.addEventListener("walletConnected", toggleAdminButtons);
    toggleAdminButtons();

    const betModal = document.getElementById('betModal');
    const buybackModal = document.getElementById('buybackModal');
    const show = el => el?.classList.replace("hidden","flex");
    const hide = el => el?.classList.replace("flex","hidden");

    document.getElementById('btn-add-bet')?.addEventListener('click', ()=> show(betModal));
    document.getElementById('closeBetBtn')?.addEventListener('click', ()=> hide(betModal));
    document.getElementById('btn-add-buyback')?.addEventListener('click', ()=> show(buybackModal));
    document.getElementById('closeBuybackBtn')?.addEventListener('click', ()=> hide(buybackModal));

    document.getElementById('saveBetBtn')?.addEventListener('click', async ()=>{
      if(!isAdmin()) return alert("Admin only");
      const title  = (document.getElementById('betTitle').value||"").trim();
      const market = (document.getElementById('betMarket').value||"").trim();
      const payout = Number((document.getElementById('betPayout').value||"").trim());
      if(!title) return alert("Title required");
      await addDoc(collection(db,"bets"), { title, market, payout:isNaN(payout)?null:payout, status:"pending", ts:serverTimestamp() });
      hide(betModal);
      ['betTitle','betMarket','betPayout'].forEach(id=> document.getElementById(id).value="");
    });

    document.getElementById('saveBuybackBtn')?.addEventListener('click', async ()=>{
      if(!isAdmin()) return alert("Admin only");
      const usd    = Number((document.getElementById('bbUSD').value||"").trim());
      const amount = Number((document.getElementById('bbAmount').value||"").trim());
      const tx     = (document.getElementById('bbTx').value||"").trim();
      const note   = (document.getElementById('bbNote').value||"").trim();
      await addDoc(collection(db,"buybacks"), { usd:isNaN(usd)?0:usd, amount:isNaN(amount)?0:amount, tx, note, ts:serverTimestamp() });

      // bump cumulative buybacksUSD
      const sSnap = await getDoc(statsRef);
      const curr  = sSnap.exists()? (sSnap.data().buybacksUSD||0) : 0;
      await setDoc(statsRef, { buybacksUSD: curr + (isNaN(usd)?0:usd) }, { merge:true });

      hide(buybackModal);
      ['bbUSD','bbAmount','bbTx','bbNote'].forEach(id=> document.getElementById(id).value="");
    });

    async function resolveBet(id,status){
      await updateDoc(doc(db,"bets",id), { status });
      // update hit rate counters
      const sSnap = await getDoc(statsRef);
      const s = sSnap.exists()? sSnap.data() : {wins:0,losses:0,hitRate:0};
      const wins   = (s.wins||0) + (status==="win"?1:0);
      const losses = (s.losses||0) + (status==="loss"?1:0);
      const hitRate = (wins+losses)? wins/(wins+losses):0;
      await setDoc(statsRef, { wins, losses, hitRate }, { merge:true });
    }
    window.__betfi = { resolveBet };

    /* ---------- Live Submissions ---------- */
    const liveContainer = document.getElementById("liveRequests");
    window.loadSubmissions = function(){
      onSnapshot(collection(db,"studio_requests"), (qs)=>{
        const docs = [];
        qs.forEach(d=> docs.push({id:d.id, ...d.data()}));
        docs.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
        liveContainer.innerHTML="";
        docs.forEach(data=>{
          const date = new Date(data.timestamp||Date.now());
          const formattedDate = date.toLocaleString('en-US',{ dateStyle:'medium', timeStyle:'short' });
          const item = document.createElement('div');
          item.className = "snap-center min-w-[280px] glass-card neon-border text-left p-4 bg-black";
          const isAdminNow = (window.connectedWallet||"").toLowerCase()===window.ADMIN_WALLET;
          item.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <div class="text-pink-400 text-sm font-bold">${data.type}</div>
              ${data.limitedMint?'<div class="text-xs bg-pink-600 px-2 py-1 rounded-full">LIMITED</div>':''}
            </div>
            <div class="text-white font-bold text-lg mb-1">${data.handle}</div>
            <p class="text-gray-300 text-sm mb-2">${data.notes||'No notes provided.'}</p>
            <p class="text-xs text-green-400 break-all mb-1">Tx: ${(data.txHash||'').slice(0,8)}...${(data.txHash||'').slice(-8)}</p>
            <p class="text-xs text-gray-500">${formattedDate}</p>
            ${isAdminNow?`
              <div class="mt-4 flex justify-between">
                <button onclick="deleteRequest('${data.id}')" class="px-3 py-1 text-xs bg-red-600 rounded">Delete</button>
                <button onclick="stampSubmission('${data.id}')" class="px-3 py-1 text-xs bg-green-500 text-black rounded">Stamp</button>
              </div>`:''
            }
          `;
          liveContainer.appendChild(item);
        });
      });
    };

    /* ---------- Certified Swipe ---------- */
    const swipe = document.getElementById("certifiedSwipeContainer");
    function createCertifiedSwipeCard(data){
      const div = document.createElement("div");
      div.className = "glass-card neon-border certified-card text-center p-4 snap-start flex-shrink-0 w-[320px]";
      const stampURL = "https://raw.githubusercontent.com/LandoCrissian/Y2kCoin-Website/refs/heads/main/3A81E5FC-A03B-4D1D-A93C-79E4C79CCA20.png";
      const posterImage = data.imageURL || "https://raw.githubusercontent.com/LandoCrissian/Y2kCoin-Website/refs/heads/main/61045FBE-92A5-4AAA-983A-6FD1C0B21D1F.png";
      div.innerHTML = `
        <img src="${stampURL}" alt="Certified" class="w-14 h-14 mx-auto mb-2" />
        <div class="text-pink-400 font-bold text-sm">${data.type}</div>
        <div class="text-lg font-bold">${data.handle}</div>
        <p class="text-sm text-gray-400 mb-2">${data.notes||"No notes provided."}</p>
        <video controls class="w-full rounded shadow-lg mt-2" poster="${posterImage}">
          <source src="${data.songURL||"#"}" type="video/mp4">
        </video>
        <div class="flex justify-center gap-2 pt-4" id="swipe-actions-${data.id}">
          <button onclick="alert('Likes coming soon!')" class="text-xs px-3 py-1 bg-pink-600 rounded">‚ô° Like</button>
          <button onclick="window.open('https://x.com/intent/tweet?text='+encodeURIComponent('üî• Found this certified submission by ${data.handle}! Listen here: https://y2kcoin.org #ROASTRECORDS #CROFAM'),'_blank')" class="text-xs px-3 py-1 bg-purple-600 rounded">Share</button>
          <button onclick="alert('NFT purchasing under development')" class="text-xs px-3 py-1 bg-green-600 rounded">Buy NFT</button>
        </div>
      `;
      if ((window.connectedWallet||"").toLowerCase()===window.ADMIN_WALLET){
        const bar = div.querySelector(`#swipe-actions-${data.id}`);
        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úé Edit";
        editBtn.className = "text-xs px-3 py-1 bg-yellow-600 rounded";
        editBtn.onclick = ()=> window.editCertified(data.id, data);
        bar.appendChild(editBtn);
      }
      swipe.appendChild(div);
    }

    window.loadCertified = function(){
      onSnapshot(collection(db,"stamped_requests"), (snap)=>{
        swipe.innerHTML="";
        snap.docs
          .map(d=>({id:d.id, ...d.data()}))
          .sort((a,b)=> (b.stampedAt||0)-(a.stampedAt||0))
          .forEach(createCertifiedSwipeCard);
      });
    };

    // Expose some helpers globally used below
    window.deleteRequest = async function(id){
      if(!confirm("Delete submission?")) return;
      await deleteDoc(doc(db,"studio_requests",id));
      showToast("Submission deleted.");
    };

    let currentStampId=null, currentStampData=null;
    window.stampSubmission = async function(id){
      const ref = doc(db,"studio_requests",id);
      const snap = await getDoc(ref);
      if(!snap.exists()){ showToast("Submission not found."); return; }
      currentStampId = id; currentStampData = snap.data();
      document.getElementById("stampModal")?.classList.remove("hidden");
    };

    window.confirmStamp = async function(){
      const songURL  = document.getElementById("stampSongURL").value.trim();
      const imageURL = document.getElementById("stampImageURL").value.trim();
      const buyNftURL= document.getElementById("stampBuyNftURL").value.trim();
      if(!songURL){ showToast("Song URL is required."); return; }
      await addDoc(collection(db,"stamped_requests"), { ...currentStampData, songURL, imageURL, buyNftURL, stampedAt:Date.now() });
      await deleteDoc(doc(db,"studio_requests", currentStampId));
      window.closeStampModal?.();
      showToast("Submission stamped.");
    };

    window.closeStampModal = function(){
      ["stampSongURL","stampImageURL","stampBuyNftURL"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
      document.getElementById("stampModal")?.classList.add("hidden");
      currentStampId=null; currentStampData=null;
    };

    window.editCertified = async function(id,data){
      const songURL = prompt("Edit Song URL:", data.songURL||""); if(songURL===null) return;
      const imageURL= prompt("Edit Image URL:", data.imageURL||""); if(imageURL===null) return;
      await updateDoc(doc(db,"stamped_requests",id), { songURL:songURL.trim(), imageURL:imageURL.trim() });
      showToast("Submission updated.");
    };

    /* ---------- Init streams on load ---------- */
    window.addEventListener("DOMContentLoaded", ()=>{
      window.loadSubmissions();
      window.loadCertified();
    });
  </script>

  <!-- Ethers + Wallet + Studio Submit (single, no duplicates) -->
  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";
    import { addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let croProvider=null;
    async function connectWallet(){
      try{
        if(!window.ethereum) throw new Error("Crypto wallet not detected.");
        croProvider = new ethers.providers.Web3Provider(window.ethereum);
        await croProvider.send("eth_requestAccounts", []);
        const signer = croProvider.getSigner();
        const address = await signer.getAddress();
        window.connectedWallet = address.toLowerCase();
        window.dispatchEvent(new Event("walletConnected"));
        const balance = await croProvider.getBalance(address);
        const formatted = ethers.utils.formatEther(balance).slice(0,6);
        document.getElementById('walletStatus').innerHTML = `Connected: ${address.slice(0,6)}...${address.slice(-4)} (${formatted} CRO)`;
      }catch(e){
        document.getElementById('walletStatus').innerHTML = `<span class="text-red-400">‚úó ${e.message}</span>`;
      }
    }
    window.connectWallet = connectWallet;

    async function sendCRO(amount,to){
      if(!croProvider) throw new Error("Wallet not connected.");
      const signer = croProvider.getSigner();
      const tx = await signer.sendTransaction({ to, value: ethers.utils.parseEther(amount) });
      return tx.hash;
    }

    async function submitStudioRequest(){
      const type   = document.getElementById('requestType').value;
      const handle = (document.getElementById('handle').value||"").trim();
      const notes  = (document.getElementById('notes').value||"").trim();
      const limitedMint = document.getElementById('limitedMint').checked;
      const status = document.getElementById('studioStatus');

      if(!type || !handle.startsWith('@')){
        status.innerHTML = `<span class="text-red-400">Please enter a valid type and handle (@handle).</span>`;
        return;
      }
      try{
        if(!croProvider) await connectWallet();
        status.innerHTML = `<span class="text-yellow-400">Sending 20 CRO...</span>`;
        const signer = croProvider.getSigner();
        const userAddress = await signer.getAddress();
        const message = `I authorize this ROAST RECORDS request from ${userAddress} at ${new Date().toISOString()}`;
        const signature = await signer.signMessage(message);
        const txHash = await sendCRO("20", window.ADMIN_WALLET); // send to admin wallet

        await addDoc(collection(window.db,"studio_requests"), {
          type, handle, notes, limitedMint, txHash, croAddress:userAddress, message, signature, timestamp:Date.now()
        });

        status.innerHTML = `<div class="text-green-400">Submitted! Tx: ${txHash}</div>`;
        window.showConfirmationOverlay(handle,type);
        document.getElementById('submissionForm').reset();
      }catch(err){
        status.innerHTML = `<span class="text-red-400">Error: ${err.message}</span>`;
      }
    }
    window.submitStudioRequest = submitStudioRequest;
  </script>

  <!-- Shared helpers (toast, portal, share overlay, particles) -->
  <script>
    function showToast(message){
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = 'px-3 py-2 bg-gray-900/90 border border-pink-600 rounded text-sm';
      t.textContent = message;
      c.appendChild(t);
      setTimeout(()=> t.remove(), 4000);
    }

    function enterPortal(){
      const portal = document.getElementById('portalEntry');
      const main   = document.getElementById('mainContent');
      portal.style.transition='all 1s ease-in-out';
      portal.style.opacity='0'; portal.style.transform='scale(1.5)';
      setTimeout(()=>{ portal.style.display='none'; main.classList.remove('hidden'); main.style.opacity='0';
        requestAnimationFrame(()=>{ main.style.transition='all .5s ease-out'; main.style.opacity='1'; });
      }, 1000);
    }

    window.showConfirmationOverlay = function(handle,type){
      const overlay = document.getElementById('confirmationOverlay');
      const shareBtn= document.getElementById('shareOnX');
      const preview = document.getElementById('sharePreview');
      const copyBtn = document.getElementById('copyBtn');
      const closeBtn= document.getElementById('closeBtn');

      overlay.classList.remove('hidden');
      const hashtags = { Roast:["#ROASTRECORDS","#CROFAM","#CryptoMusic"], Anthem:["#Y2KCoin","#CROFAM","#CryptoMusic"], Custom:["#ROASTRECORDS","#Y2K","#ChainSound"], Other:["#Y2KCoin","#VaultStudio","#CROFAM"] };
      const templates= {
        Roast:[`I just dropped a roast request inside the Vault. Let the flames begin.`,`Vault roast request submitted. You better hope it ain't about you.`,`I pulled up to ROAST RECORDS with smoke in mind. Submission locked.`],
        Anthem:[`Just locked in an anthem request at ROAST RECORDS. Energy incoming.`,`My sound. My story. Vault anthem request submitted.`,`Anthem request submitted. Soundtrack for the chain activated.`],
        Custom:[`I just cooked up a custom track submission. This one‚Äôs for the chain.`,`Custom song request locked inside ROAST RECORDS.`,`Submitted a fully personalized track request. Vault studio active.`],
        Other:[`Dropped a creative request at ROAST RECORDS.`,`Intro/Skit request submitted. Vault creativity unleashed.`,`Just added some flavor to the chain. Intro/skit request submitted.`]
      };
      const key = type==="Roast"?"Roast":type==="Anthem"?"Anthem":type==="Custom Song"?"Custom":"Other";
      const message = templates[key][Math.floor(Math.random()*templates[key].length)];
      const tags = hashtags[key].join(" ");
      const url = "https://y2kcoin.org";
      const finalText = `${message} ${tags} ${url}`;
      preview.textContent = finalText;
      shareBtn.onclick = ()=> window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(finalText)}`,'_blank');
      copyBtn.onclick  = ()=> navigator.clipboard.writeText(finalText).then(()=>showToast("Copied to clipboard.")).catch(()=>showToast("Copy failed."));
      closeBtn.onclick = ()=> overlay.classList.add('hidden');
    };

    // Smooth scroll for anchor links
    window.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('a[href^="#"]').forEach(a=>{
        a.addEventListener('click', e=>{
          const id = a.getAttribute('href'); const target = document.querySelector(id);
          if(target){ e.preventDefault(); target.scrollIntoView({behavior:'smooth'}); }
        });
      });
    });

    // Particles
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas(){ canvas.width=innerWidth; canvas.height=innerHeight; }
    resizeCanvas(); addEventListener('resize', resizeCanvas);
    const particles=[], N=50;
    class P{ constructor(){ this.reset(); }
      reset(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.size=Math.random()*2+1; this.vx=Math.random()*.5-.25; this.vy=Math.random()*.5-.25; this.color=`rgba(255,${Math.floor(Math.random()*100+100)},255,${Math.random()*.5+.2})`; }
      update(){ this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>canvas.width) this.vx*=-1; if(this.y<0||this.y>canvas.height) this.vy*=-1; }
      draw(){ ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); }
    }
    for(let i=0;i<N;i++) particles.push(new P());
    (function loop(){ ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{p.update(); p.draw();}); requestAnimationFrame(loop);}());
  </script>

  <!-- Stamp Modal (from your original) -->
  <div id="stampModal" class="fixed inset-0 bg-black/90 z-50 hidden flex justify-center items-center px-4">
    <div class="glass-card neon-border max-w-md w-full p-6 space-y-4 text-left">
      <h3 class="text-xl font-bold neon-text text-center">Stamp Submission</h3>
      <input id="stampSongURL" placeholder="IPFS Video/Audio URL" class="w-full p-2 neon-border bg-black text-white text-sm rounded" />
      <input id="stampImageURL" placeholder="Image URL (optional)" class="w-full p-2 neon-border bg-black text-white text-sm rounded" />
      <input id="stampBuyNftURL" placeholder="Buy NFT Link (optional)" class="w-full p-2 neon-border bg-black text-white text-sm rounded" />
      <div class="flex justify-between gap-4 pt-4">
        <button onclick="closeStampModal()" class="w-full glow-button text-sm bg-red-600 hover:bg-red-700">Cancel</button>
        <button onclick="confirmStamp()" class="w-full glow-button text-sm">Confirm Stamp</button>
      </div>
    </div>
  </div>
</body>
</html>
